---
title:  "서버 Swap 영역 지정"
date: 2024-06-13T16:07:45+09:00
categories: 
    - 운영체제
    - 가상 메모리
tags:
    - aws
    - ubuntu
    - devops
---

AWS Code Deploy를 이용하여 배포를 하던 과정에서 docker를 추가하여 배포를 해보았다. 배포 스크립트를 제대로 사용할 수 없었기 때문에(이 부분은 아래에서 다시 설명한다.) 개발자가 직접 환경을 통일시켜줘야했다. 예를 들어 새로운 패키지를 추가하면 배포 전에 서버에 직접 들어가서 해당 패키지를 미리 설치한다.

![](https://i.imgur.com/tlXvMKJ.gif)

위에는 배포스크립트를 실행했을 때 서버에 `htop` 으로 모니터링한 gif이다.  사용 메모리가 837까지 가다가 서버가 멈춰버린다.(이 때 Swp를 주의 깊게 봤더라면....)

저때는 몰랐지만 지금 gif를 보고 이해한 내용은 AWS EC2에서 사용할 수 있는 메모리가 950인데 배포 과정에서 사용할 수 있는 메모리를 초과한다. 그걸 감당하지 못하고 뻗어버린 상황이다. 임시 방편으로 배포 스크립트를 제거하고 배포된 코드를 반영할 수 있게 서버만 재시작하는 스크립트로 교체를 했었다.

우연히 AWS EC2에서는 Swap 메모리가 설정이 안되어 있다는 것을 발견하고 Swap 메모리를 설정해서 시스템을 좀더 개선할 수 있었다(아래는 다른 서버로 설정으로 테스트한 내용이다)

## 다른 서버에 Swap 테스트

![](https://i.imgur.com/jinYbLJ.png)
![](https://i.imgur.com/oqXtJTg.png)

프리티어 EC2에 제공되는 메모리가 1GB이고 디스크는 30GB이다. 생각보다 디스크가 넉넉한 것 같아서 swap 메모리를 10GB로 주었다. 이제 한번 확인을 해보았다

![](https://i.imgur.com/aA0DxOH.gif)

보다가 궁금한 점이 생겼다. 메모리에 여유 공간이 있는데 왜 Swap 메모리를 사용할까. 그것에 대한 이유는 `swappiness`라는 커널 파라미터 때문이다. 이 값은 0 ~ 100 사이로 설정할 수 있는데 0 이면 swap을 사용하지 않고 100이면 즉시 사용하라는 것을 의미한다.

이 `swappiness`를 설정하지 않으면 기본 값인 60으로 설정되어 있는데 이 수치는 메모리 사용이 절반을 넘었을 때 사용한다는 의미이다. 결과적으로 사용이 500을 넘기 때문에 설정 값에 따라 남은 메모리의 여유가 있어도 swap을 사용한 것이다.

스왑을 사용할 때 따져보아야 하는 것들이 있다. 먼저 현재 메모리 사용량이 크지 않다면, 스왑을 적용하는 것은 성능을 낮출 수 있다. 가상메모리 기법(swap)을 사용하면 페이지 인[^1], 페이지 아웃[^2]이 발생하기 때문에 사용하는 것 자체가 성능이 낮아진다. 만약 메모리가 부족하고 disk에 용량이 넉넉하며 잠깐의 부하는 괜찮다면 Swap을 사용하는 것은 좋은 조치일 수 있다.

결국 진리의 케바케로 현재 서비스와 시스템에 대한 이해를 기반으로 설정하는 것이 필요하다.

## 각주

[^1]: 스왑 영역에 있는 데이터를 메모리에 옮기는 작업

[^2]: 메모리에 있는 데이터를 스왑 영역으로 옮기는 작업

## 참고 링크

[why-is-swap-being-used-even-though-i-have-plenty-of-free-ram](https://askubuntu.com/questions/157793/why-is-swap-being-used-even-though-i-have-plenty-of-free-ram)

[How do I configure swappiness?](https://askubuntu.com/questions/103915/how-do-i-configure-swappiness/103916#103916)
