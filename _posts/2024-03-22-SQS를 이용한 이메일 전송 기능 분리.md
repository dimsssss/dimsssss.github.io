---
title:  "SQS를 이용한 이메일 전송 기능 분리"
date: 2024-03-22T14:00:45+09:00
categories: 
    - AWS
tags:
    - 인프라
    - AWS
---

## 문제
현재 opener는 EC2 단일 인스턴스에서 서비스되고 있다. 하나의 서버에서 모든 API를 처리해서 두 가지 문제점이 보였다.
### 장애 위험성
**single point of failure** 단일 병목 지점이라고 부른다. API 하나가 서비스 전체에 영향을 줄 수 있다. 즉 API 하나에 버그가 발생하면 서버 전체가 멈춘다.
### 늦은 응답 속도
이메일 전송 기능의 경우 API 서버에서는 특별히 처리할 것이 없다. 메일만 전송하면 된다. 이메일의 결과를 기다리느라 의미없는 대기 시간(로컬에서 5초 정도)이 발생하였다

![](https://i.imgur.com/TfbQQkW.gif)

## 목표
### API 외의 기능 분리
작업자도 없고 하루 방문객도 100 초반이어서 단일 인스턴스에 모놀리틱 구조가 좋다고 생각한다. 기존 구조를 그대로 가되 API와 직접적인 관련 없는 배치성 작업만 분리한다
### 응답 속도 개선
이메일을 보내고 결과를 받을 때까지 클라이언트에게 응답을 미룬다. 이 대기 시간을 없애서 응답 시간을 줄인다.

## 개선 방안
### 인프라 변경
이메일 전송을 다른 곳에서 처리하도록 한다. 최대한 프리티어 한도로 처리하기 위해서 lambda에서 이메일을 보내는 걸로 생각했다. 서버에서 직접 람다로 호출하면 기존 구조와 달라지는 게 없기 때문에 AWS에 SNS 서비스를 적용하여 메시지 기반 구조로 변경을 하였다. 프리티어에서도 100만개 무료라서 좋은 선택지라고 생각한다
![](https://i.imgur.com/QTGI7Wc.png)
## 결과
### 응답 시간 감소
![](https://i.imgur.com/AwTY9mb.gif)
5초에서 1초
## SNS 제거
API 서버가 publisher 역할을 하면 되어서 SNS가 불필요해졌다. 
![](https://i.imgur.com/QGJWKaj.png)

### Lambda 중복된 동작
한번 메일을 보냈는데 같은 내용으로 3개가 발송되는 현상이 있었다. 로그를 확인해 보니 동일한 메세지Id로 3개가 찍혀있었다.

![](https://i.imgur.com/eORp9yl.png)

원인을 찾아보니 lambda에 실행 시간이 설정되었는데 작업이 설정된 시간을 넘기면 재시작한다는 내용이었다. 
https://repost.aws/knowledge-center/lambda-function-process-sqs-messages

기본 설정은 3초인데 위의 사진을 보면 미세하게 3초를 넘겼다. 람다의 실행시간을 5초로 변경을 해주었더니 정확하게 한번만 동작을 하였다
