---
title:  "배포 장애 해결"
date: 2024-02-04T13:20:42+09:00
categories: 
    - 배포
tags:
    - CD
    - AWS
    - code deploy
---

사이드 프로젝트인 오프너 프로젝트(아이돌 오프라인 행사 공유 플랫폼 )를 진행하고 있는데 개발하는 도중에 장애가 간헐적으로 발생하였다. ssh로 접속을 하려고 하거나 포스트맨을 이용해 API를 테스트 해보거나 할 때 서버에 응답이 늦어지면 열에 아홉은 서버가 장애를 겪고 있었다.

서버가 '프리티어라서 성능이 안좋아서 그런가?' 라고 생각을 해보았는데 프리티어로 서비스 잘 동작하게 하는 자료도 발견을 하였고 서비스의 특성과 사용자의 이용 패턴에 따라 달라질 수 있다는 자료도 읽어보아서 무조건 프리티어 문제라고 할 수 없었다.

객관적으로 판단할만한 지표가 필요하다고 생각했고 찾아보았지만 대부분 모니터링 툴이나 서비스를 사용하는 것들이라 비용 문제로 포기하였다.
## 배포 플로우
![](https://i.imgur.com/btSYjmQ.png)

장애가 났었던 상황을 분석해 보면 항상 배포 직후에 장애가 발생을 하였다. githubaction 스크립트를 보니 배포 스크립트에 branch에 푸시가 되거나 pull request를 생성하면 배포하도록 작성되었다. 2번은 무조건 배포를 하기 때문에 혹시 이것 때문에 부하가 발생해서 장애가 났나? 추측하고  push가 되었을 때만 배포가 동작하도록 변경하였다. 그러나 효과는 없었다
## 직접 모니터링
돈이 없기 때문에 몸으로 직접 때울려고 내가 모니터링을 했다. 서버에 ssh로 접속한 후 htop 명령어를 실행해서 다른 일 하면서 띄워놓고 보고 있었다. 계속 보다가 유의미한 지표를 발견하였는데 갑자기 메모리가 폭주를 하고 있었다. 그때 프로세스를 보니 `npm ci`, `npm install` 가 많았다. 
![](https://i.imgur.com/tlXvMKJ.gif)


## 배포 스크립트 수정
code deploy가 동작하는 실행 단계가 있다.(life cycle) 그 가운데 after install 이라는 단계가 있는데 배포된 파일이 옮겨지고 나서 실행하는 단계이다. node_modules를 배포 대상에서 빼버리고 서버에서 직접 설치하도록 스크립트를 작성했는데 이 부분에서 메모리가 버티지 못하고 장애가 발생하였다

해결 방안은 만약 패키지가 새로 추가될 때 미리 서버로 접속해서 필요한 패키지만 설치하도록 다른 백엔드 분과 약속을 하였고 `npm install`, `npm ci` 스크립트를 삭제 해버렸다. 

![](https://i.imgur.com/ylQJmmJ.gif)

그 결과 서버 장애는 사라졌다. 그렇지만 매번 패키지가 새로 설치되면 접속해서 직접 설치하는 번거로움이 생겼고 순간적으로 cpu 사용량이 100%에 달하는 상황이 발생했기 때문에 계속 관찰을 해보면서 더 좋은 해결 방법을 찾아봐야겠다