---
title:  "도커를 이용한 무중단 배포"
date: 2024-06-15T16:17:45+09:00
categories: 
    - devops
tags:
    - docker
---

기존에 구축한 자동 배포는 pm2를 이용하였는데 결과적으로는 reload할 때 중단이 되는 구조였다. 잠깐의 서비스 중단이 발생하기 때문에 이를 개선하기 위해서 무중단 배포를 직접 구현하게 되었다.

배포 방식에는 여러가지 방법이 있지만 공통적으로 유지하는 프로세스는 기존에 서비스를 계속 구동시킨다. 배포된 새로운 서비스를 가동시킨다. 이렇게 되면 두 종류의 서비스가 동작하게 되는데 그 다음 과정에서 어떤 동작을 하느냐에 따라 블루-그린, 롤링, 카나리 배포 같은 유형으로 나뉘게 된다.

내가 구현한 무중단 배포는 롤링 형식으로
1. 새로운 서비스를 가동시킨다.
2. 리버스 프록시[^1]를 이용하여 들어오는 요청을 새로운 서비스로 보낸다.
3. 기존 서비스를 중단한다


배포를 할 때  하나의 리버스 프록시[^1] 역할을 하는 컨테이너[^2]와 기존에 동작하는 컨테이너, 새로운 서비스를 제공하는 컨테이너가 동작하게 된다.

![](https://i.imgur.com/6BevTi7.png)


리버스 프록시[^1]에서 새로운 서비스로 연결할 때  `sed -i`, `mv`명령어를 이용하여 nginx 설정 파일을 수정한 경우에 다음과 같은 에러를 겪었다

> sed: cannot rename /etc/nginx/: Device or resource busy
> mv: cannot move '/etc/nginx/nginx.conf.tmp' to '/etc/nginx/nginx.conf': Device or resource busy

cp를 이용하여 설정 파일을 변경했을 때는 잘 동작했는데 찾아보니 다음의 차이점들이 있었다

> - **`mv`와 `sed -i`**: 원본 파일을 변경하거나 이동하려 하기 때문에 파일이 사용 중이면 "Device or resource busy" 오류가 발생합니다.
> - **`cp`**: 원본 파일을 변경하지 않고 단순히 데이터를 복사하므로 파일이 사용 중이어도 문제 없이 동작합니다.
> Chat GPT

파일 작업을 할 때 웬만하면 `cp`를 이용하는 것이 충돌 없이 사용할 수 있다. 또한 config 파일을 하나로 사용하는 것이 아닌 나눠서 사용하는 것이 관리하기가 더 쉽다. 왜냐하면 파일 내용 가운데 정확하게 한 부분만 수정을 해야하는데 파일이 커지거나 내용이 복잡해지면 정확하게 걸러내기 쉽지 않기 때문이다. 읽는 사람도 이해하기 어려워진다.  

여기까지 과정을 쉘스크립트로 작성을 하였는데 왜 쿠버네티스[^3]를 사용하는지 약간의 느낌이 온다. 컨테이너[^2] 관리나 배포 과정이 더 복잡해진다면 쉘 스크립트[^4] 만으로는 관리하기 힘들지 않을까 하는 생각이 든다

## 각주
[^1]: 트래픽의 목적지 앞에서 먼저 트래픽을 받는 서버. 주로 보안, 정적 파일 서빙, 라우팅의 기능을 수행한다

[^2]: 어떤 환경에서나 실행하기 위해 필요한 모든 요소를 포함하는 소프트웨어 패키지. 가상 머신과의 차이점은 OS를 따로 설치하지 않는다

[^3]: 컨테이너화된 워크로드와 서비스를 관리하기 위한 이식성이 있고, 확장가능한 오픈소스 플랫폼이다. 선언적 구성과 자동화를 모두 용이하게 해준다.

[^4]: [셸](https://ko.wikipedia.org/wiki/%EC%85%B8 "셸")이나 [명령 줄 인터프리터](https://ko.wikipedia.org/wiki/%EB%AA%85%EB%A0%B9_%EC%A4%84_%EC%9D%B8%ED%84%B0%ED%94%84%EB%A6%AC%ED%84%B0 "명령 줄 인터프리터")에서 돌아가도록 작성되었거나 한 [운영 체제](https://ko.wikipedia.org/wiki/%EC%9A%B4%EC%98%81_%EC%B2%B4%EC%A0%9C "운영 체제")를 위해 쓰인 [스크립트](https://ko.wikipedia.org/wiki/%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8_%EC%96%B8%EC%96%B4 "스크립트 언어")이다. 단순한 [도메인 고유 언어](https://ko.wikipedia.org/w/index.php?title=%EB%8F%84%EB%A9%94%EC%9D%B8_%EA%B3%A0%EC%9C%A0_%EC%96%B8%EC%96%B4&action=edit&redlink=1 "도메인 고유 언어 (없는 문서)")로 여기기도 한다. 셸 스크립트가 수행하는 일반 기능으로는 파일 이용, 프로그램 실행, 문자열 출력 등이 있다.
